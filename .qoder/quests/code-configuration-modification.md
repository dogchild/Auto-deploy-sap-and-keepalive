# SAP代理节点自动部署系统代码配置修改设计

## 概述

本设计文档针对SAP Cloud自动部署工作流进行三个关键配置修改：内存和硬盘资源调整、Docker镜像升级、以及免费区域的环境变量差异化处理。这些修改旨在提升部署资源配置并增强对不同区域的支持。

## 修改需求分析

### 资源配置调整
- **内存配置**：从默认256M增加到512M，提升应用运行性能
- **硬盘配置**：从默认256M增加到512M，确保足够存储空间

### Docker镜像升级
- **现有镜像**：ghcr.io/eooce/nodejs:main
- **目标镜像**：ghcr.io/dogchild/nodejs-argo-xray:main
- **影响范围**：Argo隧道CDN部署类型

### 免费区域环境变量差异化
- **区域识别**：SG(free)和US(free)为免费区域
- **环境变量来源**：
  - SG(free)：ARGO_AUTH_SG、ARGO_DOMAIN_SG
  - US(free)：ARGO_AUTH_US、ARGO_DOMAIN_US
- **设置规则**：后续环境变量设置仍使用标准名称ARGO_AUTH和ARGO_DOMAIN

### 哪吒监控组件移除
- **移除范围**：所有与哪吒监控相关的环境变量和配置
- **影响组件**：
  - NEZHA_SERVER环境变量
  - NEZHA_PORT环境变量
  - NEZHA_KEY环境变量
- **清理目标**：简化部署配置，专注于代理节点功能

## 技术架构设计

### 1. GitHub Actions工作流修改架构

#### 环境变量处理层
```
graph TB
    A[用户选择部署区域] --> B{是否为免费区域?}
    B -->|SG_free| C[使用ARGO_AUTH_SG和ARGO_DOMAIN_SG]
    B -->|US_free| D[使用ARGO_AUTH_US和ARGO_DOMAIN_US]
    B -->|企业版区域| E[使用标准ARGO_AUTH和ARGO_DOMAIN]
    C --> F[设置环境变量为ARGO_AUTH和ARGO_DOMAIN]
    D --> F
    E --> F
    F --> G[应用部署]
```

#### 资源配置层
```
graph LR
    A[部署配置] --> B[内存: 512M]
    A --> C[硬盘: 512M]
    A --> D[Docker镜像选择]
    D --> E[dogchild/nodejs-argo-xray:main]
```

### 2. 配置管理策略

#### 区域检测机制
| 区域类型 | 区域标识 | 环境变量来源 | 设置目标 |
|---------|---------|------------|----------|
| 免费新加坡 | SG(free) | ARGO_AUTH_SG, ARGO_DOMAIN_SG | ARGO_AUTH, ARGO_DOMAIN |
| 免费美国 | US(free) | ARGO_AUTH_US, ARGO_DOMAIN_US | ARGO_AUTH, ARGO_DOMAIN |
| 企业版区域 | 其他所有 | ARGO_AUTH, ARGO_DOMAIN | ARGO_AUTH, ARGO_DOMAIN |

#### 哪吒监控组件移除策略
| 组件类型 | 移除范围 | 处理方式 |
|---------|---------|----------|
| 环境变量设置 | NEZHA_SERVER, NEZHA_PORT, NEZHA_KEY | 从workflow中完全删除 |
| README文档 | 哪吒监控配置说明 | 移除相关配置说明 |
| 保活脚本 | 哪吒相关配置项 | 清理哪吒监控相关代码 |

#### 环境变量映射逻辑
1. **区域识别阶段**：根据用户选择的region参数确定区域类型
2. **变量获取阶段**：根据区域类型从对应的secrets中获取配置
3. **变量设置阶段**：统一使用标准环境变量名称进行应用配置

### 3. 资源配置更新

#### 内存配置调整
- **现有配置**：MEMORY=256M，disk配额256M
- **更新配置**：MEMORY=512M，disk配额512M
- **影响组件**：Cloud Foundry push命令参数

#### Docker镜像配置
- **Argo隧道CDN类型**：使用新镜像ghcr.io/dogchild/nodejs-argo-xray:main
- **直连类型**：保持现有镜像不变
- **自定义镜像**：优先使用用户自定义DOCKER_IMAGE

## 实施方案

### 1. GitHub Actions工作流修改

#### 环境变量配置部分
在"Determine CF API endpoint and app name"步骤中，增加免费区域的环境变量处理逻辑，同时移除哪吒监控相关配置：

```
flowchart TD
    A[检测部署区域] --> B{区域类型判断}
    B -->|SG_free| C[设置CF_API为新加坡]
    B -->|US_free| D[设置CF_API为美国]
    B -->|企业版| E[设置对应企业版API]
    
    C --> F[获取ARGO_AUTH_SG]
    D --> G[获取ARGO_AUTH_US]
    E --> H[获取标准ARGO_AUTH]
    
    F --> I[映射为ARGO_AUTH环境变量]
    G --> I
    H --> I
    
    I --> J[继续部署流程]
```

#### 资源配置修改
- **内存配置**：更新MEMORY环境变量为512M
- **部署命令**：调整cf push的内存和磁盘参数

#### Docker镜像选择逻辑
保持现有的镜像选择逻辑，但更新Argo隧道CDN的默认镜像。

#### 哪吒监控组件清理
从"Set environment variables"步骤中移除以下环境变量设置：
- cf set-env命令中的NEZHA_SERVER配置
- cf set-env命令中的NEZHA_PORT配置  
- cf set-env命令中的NEZHA_KEY配置

### 2. README文档更新

#### 环境变量说明更新
在secrets配置说明中，增加免费区域的专用环境变量说明，同时移除哪吒监控相关配置：

| 环境变量 | 说明 | 适用区域 | 状态 |
|---------|------|---------|------|
| ARGO_AUTH | 标准隧道认证 | 企业版区域 | 保留 |
| ARGO_DOMAIN | 标准隧道域名 | 企业版区域 | 保留 |
| ARGO_AUTH_SG | 新加坡免费区域隧道认证 | SG(free) | 新增 |
| ARGO_DOMAIN_SG | 新加坡免费区域隧道域名 | SG(free) | 新增 |
| ARGO_AUTH_US | 美国免费区域隧道认证 | US(free) | 新增 |
| ARGO_DOMAIN_US | 美国免费区域隧道域名 | US(free) | 新增 |
| NEZHA_SERVER | 哪吒监控服务器 | 所有区域 | **删除** |
| NEZHA_PORT | 哪吒监控端口 | 所有区域 | **删除** |
| NEZHA_KEY | 哪吒监控密钥 | 所有区域 | **删除** |

#### 资源配置说明更新
更新部署要求和资源配置说明，明确512M的内存和磁盘配置。

#### Docker镜像说明更新
更新Docker镜像相关说明，反映新的默认镜像。

#### 监控组件说明更新
- 移除哪吒监控相关的配置说明
- 更新可选环境变量列表，删除哪吒监控相关项目
- 简化部署流程说明，专注于代理节点核心功能

### 3. 兼容性考虑

#### 向后兼容性
- 企业版区域继续使用原有的环境变量名称
- 自定义DOCKER_IMAGE仍具有最高优先级
- 现有的直连镜像配置保持不变
- 移除哪吒监控不影响现有代理节点功能

#### 错误处理
- 免费区域缺少专用环境变量时的降级处理
- 无效区域选择的错误提示
- 资源不足时的清理机制
- 哪吒监控组件移除的平滑过渡

### 4. 哪吒监控移除影响分析

#### 功能影响评估
- **核心功能**：代理节点部署和运行不受影响
- **监控能力**：失去节点状态监控功能
- **管理复杂度**：降低配置复杂度，简化部署流程

#### 替代方案
- 使用内置的应用健康检查机制
- 依靠Cloud Foundry平台的监控能力
- 可通过访问应用URL进行状态检查

## 测试策略

### 1. 功能测试

#### 环境变量测试场景
| 测试场景 | 区域 | 预期行为 |
|---------|------|----------|
| SG免费区域部署 | SG(free) | 使用ARGO_AUTH_SG和ARGO_DOMAIN_SG |
| US免费区域部署 | US(free) | 使用ARGO_AUTH_US和ARGO_DOMAIN_US |
| 企业版区域部署 | AWS-US(VA) | 使用标准ARGO_AUTH和ARGO_DOMAIN |
| 哪吒监控移除验证 | 所有区域 | 确认不设置NEZHA相关环境变量 |

#### 资源配置测试
- 验证512M内存配置生效
- 验证512M磁盘配置生效
- 验证新Docker镜像部署成功

#### 镜像选择测试
- 验证Argo隧道CDN使用新镜像
- 验证直连类型使用原镜像
- 验证自定义镜像优先级

### 2. 集成测试

#### 端到端部署测试
- 完整的免费区域部署流程
- 完整的企业版区域部署流程
- 环境变量正确传递和设置
- 验证哪吒监控组件完全移除

#### 兼容性测试
- 现有部署配置的兼容性
- 缺少新环境变量时的降级行为
- 多区域混合部署场景
- 哪吒监控移除后的功能完整性测试

## 监控和维护

### 1. 部署监控

#### 关键指标
- 部署成功率
- 资源使用情况（512M配置的效果）
- 不同镜像的部署表现

#### 错误监控
- 环境变量缺失错误
- 资源不足错误
- 镜像拉取失败
- 验证哪吒监控相关错误不再出现

### 2. 维护计划

#### 定期检查项目
- 环境变量配置的完整性
- 资源配置的合理性
- Docker镜像的可用性
- 确认哪吒监控组件已完全清理

#### 优化建议
- 根据实际使用情况调整资源配置
- 监控新镜像的性能表现
- 收集用户反馈进行改进
- 评估是否需要替代监控方案
- 持续优化简化后的部署流程
